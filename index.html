<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Редактор товаров</title>
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --radius: 8px;
            --radius-sm: 6px;
            --transition: 0.15s;
            
            /* Telegram ThemeParams */
            --bg: var(--tg-theme-bg-color, #1a1a1a);
            --text: var(--tg-theme-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #999999);
            --link: var(--tg-theme-link-color, #5a9fd4);
            --button: var(--tg-theme-button-color, #5a9fd4);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #2a2a2a);
            --header-bg: var(--tg-theme-header-bg-color, #2a2a2a);
            --accent-text: var(--tg-theme-accent-text-color, #5a9fd4);
            --section-bg: var(--tg-theme-section-bg-color, #333333);
            --section-header: var(--tg-theme-section-header-text-color, #ffffff);
            --separator: var(--tg-theme-section-separator-color, #444444);
            --subtitle: var(--tg-theme-subtitle-text-color, #aaaaaa);
            --destructive: var(--tg-theme-destructive-text-color, #ff6b6b);
            --bottom-bar: var(--tg-theme-bottom-bar-bg-color, #2a2a2a);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* Panels */
        .panel {
            display: flex;
            flex-direction: column;
            background: var(--secondary-bg);
            overflow: hidden;
        }

        .panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--separator);
            background: var(--header-bg);
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }

        .panel-title i {
            color: var(--accent-text);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .panel-content::-webkit-scrollbar {
            width: 4px;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: var(--hint);
            border-radius: 2px;
        }

        .panel-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--separator);
            background: var(--secondary-bg);
            flex-shrink: 0;
        }

        .left-panel {
            width: 280px;
            border-right: 1px solid var(--separator);
        }

        .center-panel {
            flex: 1;
            min-width: 320px;
            background: var(--bg);
        }

        .right-panel {
            width: 380px;
            border-left: 1px solid var(--separator);
        }

        /* Form Elements */
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 13px;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--link);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235a9fd4' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 32px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            color: var(--subtitle);
            margin-bottom: 6px;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            padding: 10px 14px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: var(--transition);
        }

        .btn:hover {
            background: var(--separator);
            border-color: var(--link);
        }

        .btn-primary {
            background: var(--button);
            color: var(--button-text);
            border-color: var(--button);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .btn-danger {
            background: var(--destructive);
            color: white;
            border-color: var(--destructive);
        }

        .btn-sm {
            padding: 8px 10px;
            font-size: 12px;
        }

        .btn-block {
            width: 100%;
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 10px;
        }

        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--hint);
            font-size: 13px;
        }

        .search-input {
            width: 100%;
            padding: 10px 10px 10px 34px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 13px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--link);
        }

        /* Item List */
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: var(--section-bg);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .item:hover {
            background: var(--separator);
        }

        .item.selected {
            background: var(--button);
            color: var(--button-text);
        }

        .item-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: var(--transition);
        }

        .item:hover .item-actions,
        .item.selected .item-actions {
            opacity: 1;
        }

        .item-btn {
            width: 26px;
            height: 26px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .item-btn-copy {
            background: #4caf50;
            color: white;
        }

        .item-btn-delete {
            background: var(--destructive);
            color: white;
        }

        /* Sections */
        .section {
            margin-bottom: 16px;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-text);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title i {
            font-size: 11px;
        }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--section-bg);
            border-radius: var(--radius);
            cursor: pointer;
            margin-bottom: 10px;
        }

        .bump-toggle-section {
            background: var(--section-bg);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 12px;
        }

        .bump-toggle-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .bump-toggle-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .bump-toggle-title i {
            color: var(--subtitle);
        }

        .bump-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .bump-status.off {
            background: var(--separator);
            color: var(--hint);
        }

        .bump-status.on {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .bump-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Auto Responses */
        .ar-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            padding: 6px;
        }

        .ar-list::-webkit-scrollbar {
            width: 4px;
        }

        .ar-list::-webkit-scrollbar-thumb {
            background: var(--hint);
            border-radius: 2px;
        }

        .ar-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: var(--secondary-bg);
            border-radius: var(--radius-sm);
        }

        .ar-text {
            flex: 1;
            padding: 6px 8px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .ar-actions {
            display: flex;
            gap: 4px;
        }

        .ar-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            background: var(--destructive);
            color: white;
        }

        .ar-btn.edit {
            background: var(--link);
        }

        /* AR Select */
        .ar-select-wrapper {
            position: relative;
        }

        .ar-select-wrapper input {
            cursor: pointer;
        }

        .ar-select-dropdown {
            position: fixed;
            max-height: 180px;
            overflow-y: auto;
            background: var(--secondary-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .ar-select-dropdown::-webkit-scrollbar {
            width: 4px;
        }

        .ar-select-dropdown::-webkit-scrollbar-thumb {
            background: var(--hint);
            border-radius: 2px;
        }

        .ar-select-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ar-select-option:hover {
            background: var(--separator);
        }

        .ar-select-option.selected {
            background: var(--button);
            color: var(--button-text);
        }

        .ar-fixed-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .ar-fixed-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--separator);
            background: var(--secondary-bg);
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--hint);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: var(--transition);
        }

        .tab i {
            font-size: 13px;
        }

        .tab:hover {
            color: var(--text);
            background: var(--section-bg);
        }

        .tab.active {
            color: var(--link);
            border-bottom-color: var(--link);
        }

        .tab-content {
            display: none;
            padding: 12px;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* RC Cards */
        .rc-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .rc-list::-webkit-scrollbar {
            width: 4px;
        }

        .rc-list::-webkit-scrollbar-thumb {
            background: var(--hint);
            border-radius: 2px;
        }

        .rc-card {
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .rc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--separator);
        }

        .rc-card-title {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rc-card-title i {
            color: var(--subtitle);
        }

        .rc-card-body {
            padding: 10px 12px;
        }

        .rc-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: var(--secondary-bg);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
        }

        .rc-row:last-child {
            margin-bottom: 0;
        }

        .rc-row input {
            flex: 1;
            width: 0;
            padding: 6px 8px;
            text-align: center;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 12px;
            outline: none;
        }

        .rc-row input:focus {
            border-color: var(--link);
        }

        .rc-row .sep {
            color: var(--hint);
            font-size: 11px;
        }

        .rc-preview {
            margin-top: 10px;
            padding: 10px;
            background: var(--section-bg);
            border-radius: var(--radius);
            font-size: 12px;
        }

        .rc-preview-title {
            font-size: 10px;
            color: var(--hint);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .rc-preview-row {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
            color: var(--subtitle);
        }

        .rc-preview-row span {
            color: var(--text);
            font-weight: 500;
        }

        .rc-preview-intervals {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .rc-preview-interval {
            font-size: 11px;
            color: var(--subtitle);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .rc-preview-interval i {
            font-size: 8px;
            color: var(--accent-text);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
            backdrop-filter: blur(2px);
        }

        .modal {
            background: var(--secondary-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-wide {
            max-width: 700px;
        }

        .modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--separator);
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            color: var(--text);
        }

        .modal-header i {
            color: var(--accent-text);
        }

        .modal-body {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-body-sidebar {
            display: flex;
            gap: 16px;
            padding: 0;
        }

        .modal-main {
            flex: 1;
            padding: 16px;
            min-width: 0;
        }

        .modal-sidebar {
            width: 280px;
            background: var(--section-bg);
            border-left: 1px solid var(--separator);
            padding: 16px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .modal-sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-text);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .modal-sidebar-text {
            font-size: 13px;
            color: var(--subtitle);
            white-space: pre-wrap;
            line-height: 1.6;
            word-break: break-all;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--separator);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        .modal-intervals {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }

        .modal-interval {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-interval input {
            flex: 1;
            width: 0;
            padding: 8px 10px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            outline: none;
        }

        .modal-interval input:focus {
            border-color: var(--link);
        }

        .modal-error {
            color: var(--destructive);
            font-size: 11px;
            margin-top: 8px;
            min-height: 16px;
        }

        /* Format Toolbar */
        .format-toolbar {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .format-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius-sm);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all var(--transition);
        }

        .format-btn:hover {
            background: var(--separator);
            border-color: var(--link);
            color: var(--link);
        }

        .format-btn:active {
            transform: scale(0.95);
        }

        /* Textarea */
        .modal-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px 12px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            resize: vertical;
            outline: none;
            font-family: inherit;
        }

        .modal-textarea:focus {
            border-color: var(--link);
        }

        /* Preview */
        .ar-preview {
            margin-top: 10px;
            padding: 10px;
            background: var(--section-bg);
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            font-size: 13px;
            line-height: 1.6;
            color: var(--text);
            min-height: 60px;
            max-height: 150px;
            overflow-y: auto;
            word-wrap: break-word;
        }

        .ar-preview:empty::before {
            content: "Превью текста...";
            color: var(--hint);
        }

        .ar-preview-label {
            font-size: 11px;
            color: var(--subtitle);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .ar-preview ul, .ar-preview ol {
            margin: 0;
            padding-left: 20px;
        }

        .ar-preview li {
            margin-bottom: 4px;
        }

        /* Bulk Preview */
        .modal-bulk-preview {
            margin-top: 16px;
            border: 1px solid var(--separator);
            border-radius: var(--radius);
            background: var(--section-bg);
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-bulk-preview::-webkit-scrollbar {
            width: 4px;
        }

        .modal-bulk-preview::-webkit-scrollbar-thumb {
            background: var(--hint);
            border-radius: 2px;
        }

        .bulk-preview-header {
            padding: 10px 12px;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--separator);
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-text);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
        }

        .bulk-preview-item {
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            border-bottom: 1px solid var(--separator);
        }

        .bulk-preview-item:last-child {
            border-bottom: none;
        }

        .bulk-preview-old {
            font-size: 12px;
            color: var(--destructive);
            text-decoration: line-through;
            margin-bottom: 4px;
        }

        .bulk-preview-new {
            font-size: 12px;
            color: #4caf50;
        }

        .bulk-preview-count {
            margin-top: 8px;
            font-size: 12px;
            color: var(--hint);
        }

        .bulk-preview-empty {
            padding: 20px;
            text-align: center;
            color: var(--hint);
            font-size: 13px;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 16px;
            background: var(--section-bg);
            border: 1px solid var(--accent-text);
            border-radius: var(--radius);
            z-index: 1001;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideUp 0.2s ease;
        }

        .notification.success {
            border-color: #4caf50;
        }

        .notification.error {
            border-color: var(--destructive);
        }

        .notification i {
            font-size: 14px;
        }

        .notification.success i {
            color: #4caf50;
        }

        .notification.error i {
            color: var(--destructive);
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--hint);
        }

        .empty-state i {
            font-size: 36px;
            opacity: 0.3;
            margin-bottom: 10px;
        }

        .empty-state h3 {
            margin: 0 0 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--subtitle);
        }

        .empty-state p {
            margin: 0;
            font-size: 12px;
        }

        /* Hint */
        .hint {
            font-size: 11px;
            color: var(--hint);
            margin-top: 4px;
        }

        /* Info */
        .info-text {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .info-check-label {
            margin-bottom: 8px;
            padding: 8px 10px;
            font-size: 12px;
        }

        .info-check-input {
            width: 16px;
            height: 16px;
            accent-color: var(--button);
        }

        /* Footer */
        .footer-actions {
            display: flex;
            gap: 8px;
        }

        .footer-btn-info {
            flex: 0 0 44px;
            height: 44px;
            padding: 0;
        }

        .footer-btn-export {
            flex: 1;
        }

        .items-count {
            font-weight: 400;
            color: var(--text);
            font-size: 13px;
            margin-left: auto;
        }

        /* Layout helpers */
        .section-stretch {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 12px;
        }

        .section-auto {
            flex: 0 0 auto;
        }

        .section-pad-top {
            padding-top: 12px;
        }

        .margin-top {
            margin-top: 12px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .left-panel { width: 240px; }
            .right-panel { width: 320px; }
        }

        @media (max-width: 900px) {
            html, body {
                height: 100vh;
                overflow: hidden;
            }
            
            .app {
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                height: 100vh;
            }
            
            .app.snap-enabled {
                scroll-snap-type: x mandatory;
            }
            
            .app::-webkit-scrollbar {
                display: none;
            }
            
            /* Left panel: 85% width, shows hint of center panel */
            .left-panel {
                flex-shrink: 0;
                width: 85vw;
                height: 100vh;
                border: none !important;
                border-right: 1px solid var(--separator) !important;
                scroll-snap-align: start;
                scroll-snap-stop: always;
                overflow: hidden;
            }
            
            /* Center panel: 100% width, full screen */
            .center-panel {
                flex-shrink: 0;
                width: 100vw;
                height: 100vh;
                border: none !important;
                border-right: 1px solid var(--separator) !important;
                scroll-snap-align: start;
                scroll-snap-stop: always;
                overflow: hidden;
            }
            
            /* Right panel: 85% width, shows hint of center panel */
            .right-panel {
                flex-shrink: 0;
                width: 85vw;
                height: 100vh;
                border: none !important;
                scroll-snap-align: start;
                scroll-snap-stop: always;
                overflow: hidden;
            }
            
            .panel-content {
                max-height: calc(100vh - 140px);
                overflow-y: auto;
            }
            
            .item-actions { opacity: 1; }
            
            .modal-overlay {
                padding: 10px;
                align-items: flex-end;
            }
            
            .modal { max-height: 85vh; }
        }

        @media (max-width: 480px) {
            html, body { font-size: 13px; }
            .panel-header { padding: 10px 12px; }
            .panel-title { font-size: 14px; }
            .panel-content { padding: 10px; }
            .search-input { font-size: 16px; padding: 12px 12px 12px 36px; }
            .item { padding: 10px 12px; }
            .item-name { font-size: 13px; }
            .item-btn { width: 28px; height: 28px; font-size: 13px; }
            .tabs { padding: 0; }
            .tab { padding: 12px 8px; font-size: 11px; flex-direction: column; gap: 4px; }
            .tab i { font-size: 16px; }
            .tab span { display: none; }
            .section-title { font-size: 10px; }
            .form-input, .form-select { font-size: 16px; padding: 12px; }
            .btn { padding: 12px 14px; font-size: 13px; min-height: 44px; }
            .btn-sm { padding: 10px 12px; }
            .modal-header { padding: 12px 16px; font-size: 14px; }
            .modal-body { padding: 16px; }
            .modal-footer { padding: 12px 16px; }
            .modal-wide { max-width: 100%; }
            .modal-body-sidebar { flex-direction: column; }
            .modal-sidebar { width: 100%; border-left: none; border-top: 1px solid var(--separator); max-height: 200px; }
            .notification {
                left: 10px;
                right: 10px;
                transform: none;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Left Panel - Items List -->
        <div class="panel left-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-box"></i>
                    Товары
                    <span class="items-count" id="items-count">(0)</span>
                </h2>
            </div>
            <div class="panel-content">
                <button class="btn btn-primary btn-block btn-sm" id="add-item-btn" style="margin-bottom: 10px">
                    <i class="fas fa-plus"></i> Добавить товар
                </button>
                <button class="btn btn-block btn-sm" id="bulk-edit-btn" style="margin-bottom: 10px">
                    <i class="fas fa-edit"></i> Bulk Edit
                </button>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="search-input" placeholder="Поиск...">
                </div>
                <div class="item-list" id="items-list"></div>
            </div>
            <div class="panel-footer">
                <label class="toggle-row info-check-label">
                    <span>Подтверждать удаление</span>
                    <input type="checkbox" id="confirm-delete" class="info-check-input" checked>
                </label>
                <div class="footer-actions">
                    <button class="btn btn-primary footer-btn-info" id="info-btn" title="Информация">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-success footer-btn-export" id="export-btn">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                </div>
            </div>
        </div>

        <!-- Center Panel - Item Settings -->
        <div class="panel center-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-sliders-h"></i>
                    Настройки
                </h2>
            </div>
            <div class="panel-content" id="item-settings"></div>
        </div>

        <!-- Right Panel - Global Settings -->
        <div class="panel right-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-cogs"></i>
                    Настройки
                </h2>
            </div>
            <div class="tabs">
                <button class="tab active" data-tab="auto">
                    <i class="fas fa-reply"></i>
                    <span>Авто-ответы</span>
                </button>
                <button class="tab" data-tab="rc">
                    <i class="fas fa-rocket"></i>
                    <span>Авто-поднятие</span>
                </button>
            </div>
            <div class="tab-content active" id="auto-tab"></div>
            <div class="tab-content" id="rc-tab"></div>
        </div>
    </div>

    <script>
        // Constants
        const CONSTANTS = {
            DEFAULT_MODULES: { ItemReupload: [] },
            WORKING_LINKS: `https://plrk.co/p/roblox_login
https://plrk.co/p/roblox_creations
https://plrk.co/p/roblox_transactions
https://plrk.co/p/roblox_redeem
https://plrk.co/p/minecraft_redeem
https://plrk.co/p/xbox_login
https://plrk.co/p/microsoft_login
https://plrk.co/p/microsoft
https://plrk.co/p/exitlag_redeem
https://plrk.co/p/steamcis
https://plrk.co/p/steam_region
https://plrk.co/p/fortnite_redeem
https://plrk.co/p/battlenet_redeem
https://plrk.co/p/ea_redeem`,
            ALLOWED_TAGS: ["i", "u", "b", "s", "strong", "ul", "ol", "li"],
            AR_MAX_LENGTH: 1000,
            RC_KEY_MAX: 8,
            POSITION_MAX: 65535,
            INTERVAL_MAX: 24,
            MAX_INTERVALS: 10,
        };

        // State
        const state = {
            items: [],
            autoResponses: [],
            rc: {},
            modules: {},
            selectedIndex: -1,
            brotli: null,
            confirmDelete: true,
            searchQuery: "",
            currentPanel: 0 // 0 = left, 1 = center, 2 = right
        };

        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        // Utilities
        const base64ToData = (base64) => new Uint8Array([...atob(base64)].map(c => c.charCodeAt(0)));
        const dataToBase64 = (data) => btoa(String.fromCharCode(...data));

        // Mobile Navigation
        const isMobile = () => window.innerWidth <= 900;
        
        // Panel widths in mobile: left=85%, center=100%, right=85%
        const getPanelWidths = () => {
            const vw = window.innerWidth;
            return [vw * 0.85, vw, vw * 0.85];
        };
        
        const scrollToPanel = (index) => {
            if (!isMobile()) return;
            const app = document.querySelector('.app');
            const widths = getPanelWidths();
            
            let scrollPosition = 0;
            for (let i = 0; i < index; i++) {
                scrollPosition += widths[i];
            }
            
            // Отключаем scroll-snap перед программным скроллом
            app.classList.remove('snap-enabled');
            
            // Мгновенный скролл без анимации
            app.scrollLeft = scrollPosition;
            
            // Включаем scroll-snap обратно после скролла
            requestAnimationFrame(() => {
                app.classList.add('snap-enabled');
            });
            
            state.currentPanel = index;
        };
        
        // Touch handling for swipe
        let touchStartX = 0;
        let touchEndX = 0;
        
        const handleTouchStart = (e) => {
            touchStartX = e.changedTouches[0].screenX;
        };
        
        const handleTouchEnd = (e) => {
            if (!isMobile()) return;
            touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            const threshold = 80; // Увеличенный порог для более точного свайпа
            
            if (Math.abs(diff) > threshold) {
                if (diff > 0 && state.currentPanel < 2) {
                    // Swipe left - next panel
                    scrollToPanel(state.currentPanel + 1);
                } else if (diff < 0 && state.currentPanel > 0) {
                    // Swipe right - previous panel
                    scrollToPanel(state.currentPanel - 1);
                }
            }
        };
        
        // Get current panel based on scroll position
        const getCurrentPanelFromScroll = (scrollLeft) => {
            const widths = getPanelWidths();
            const leftEnd = widths[0]; // 85vw
            const centerEnd = widths[0] + widths[1]; // 85vw + 100vw = 185vw
            
            if (scrollLeft < leftEnd * 0.8) return 0; // В левой панели
            if (scrollLeft < centerEnd - widths[2] * 0.2) return 1; // В центральной панели
            return 2; // В правой панели
        };

        const showNotification = (message, type = "info") => {
            document.querySelector(".notification")?.remove();
            const notification = document.createElement("div");
            notification.className = `notification ${type}`;
            const icons = { error: "fa-exclamation-circle", success: "fa-check-circle", info: "fa-info-circle" };
            notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2500);
        };

        const sanitizeHTML = (html) => {
            const div = document.createElement("div");
            div.innerHTML = html;
            
            const stripTags = (node) => {
                const tag = node.tagName?.toLowerCase();
                if (CONSTANTS.ALLOWED_TAGS.includes(tag)) {
                    const el = document.createElement(tag);
                    Array.from(node.childNodes).forEach(child => {
                        el.appendChild(child.nodeType === Node.TEXT_NODE ? child.cloneNode(true) : stripTags(child));
                    });
                    return el;
                }
                return node.nodeType === Node.TEXT_NODE ? node.cloneNode(true) : null;
            };
            
            const result = document.createElement("div");
            Array.from(div.childNodes).forEach(child => {
                const stripped = stripTags(child);
                if (stripped) result.appendChild(stripped);
            });
            return result.innerHTML;
        };

        const insertTag = (textarea, tag) => {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.substring(start, end);
            const before = text.substring(0, start);
            const after = text.substring(end);

            let insertText, newStart, newEnd;
            
            if (tag === "ul" || tag === "ol") {
                insertText = `<${tag}>\n<li></li>\n</${tag}>`;
                newStart = newEnd = start + tag.length + 3;
            } else if (tag === "li") {
                insertText = "<li></li>";
                newStart = newEnd = start + 4;
            } else {
                insertText = `<${tag}>${selected}</${tag}>`;
                newStart = start + tag.length + 2;
                newEnd = end + tag.length + 2;
            }
            
            textarea.value = before + insertText + after;
            textarea.selectionStart = newStart;
            textarea.selectionEnd = newEnd;
            textarea.focus();
        };

        const createModal = (html) => {
            const overlay = document.createElement("div");
            overlay.className = "modal-overlay";
            overlay.innerHTML = html;
            document.body.appendChild(overlay);
            return overlay;
        };

        const formatToolbarHTML = `
            <div class="format-toolbar">
                <button class="format-btn" data-tag="b" title="Жирный"><i class="fas fa-bold"></i></button>
                <button class="format-btn" data-tag="i" title="Курсив"><i class="fas fa-italic"></i></button>
                <button class="format-btn" data-tag="u" title="Подчёркнутый"><i class="fas fa-underline"></i></button>
                <button class="format-btn" data-tag="s" title="Зачёркнутый"><i class="fas fa-strikethrough"></i></button>
                <button class="format-btn" data-tag="strong" title="Strong"><b>STR</b></button>
                <button class="format-btn" data-tag="ul" title="Список"><i class="fas fa-list-ul"></i></button>
                <button class="format-btn" data-tag="ol" title="Нумерованный"><i class="fas fa-list-ol"></i></button>
                <button class="format-btn" data-tag="li" title="Элемент"><i class="fas fa-square"></i></button>
            </div>`;

        // Modal Functions
        const showARModal = (isEdit = false, arId = null) => {
            const ar = isEdit ? state.autoResponses.find(a => a.id === arId) : null;
            const overlay = createModal(`
                <div class="modal modal-wide">
                    <div class="modal-header">
                        <i class="fas ${isEdit ? 'fa-pencil-alt' : 'fa-plus-circle'}"></i>
                        ${isEdit ? 'Редактировать авто-ответ' : 'Новый авто-ответ'}
                    </div>
                    <div class="modal-body modal-body-sidebar">
                        <div class="modal-main">
                            <label class="form-label">Текст</label>
                            ${formatToolbarHTML}
                            <textarea class="modal-textarea" id="ar-text" placeholder="Текст ответа..." maxlength="${CONSTANTS.AR_MAX_LENGTH}">${isEdit ? ar.text : ''}</textarea>
                            <p class="hint">Максимум ${CONSTANTS.AR_MAX_LENGTH} символов. Доступные теги: &lt;b&gt;, &lt;i&gt;, &lt;u&gt;, &lt;s&gt;, &lt;strong&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;</p>
                            <div class="ar-preview-label">Превью</div>
                            <div class="ar-preview" id="ar-preview">${isEdit ? ar.text : ''}</div>
                            <div class="modal-error" id="modal-error"></div>
                        </div>
                        <div class="modal-sidebar">
                            <div class="modal-sidebar-title">Рабочие гиперссылки</div>
                            <div class="modal-sidebar-text">${CONSTANTS.WORKING_LINKS}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-sm" id="modal-cancel">Отмена</button>
                        <button class="btn btn-success btn-sm" id="modal-save">
                            <i class="fas ${isEdit ? 'fa-check' : 'fa-plus'}"></i>
                            ${isEdit ? 'Сохранить' : 'Добавить'}
                        </button>
                    </div>
                </div>`);

            const textarea = document.getElementById("ar-text");
            const errorDiv = document.getElementById("modal-error");
            const previewDiv = document.getElementById("ar-preview");

            const updatePreview = () => {
                previewDiv.innerHTML = sanitizeHTML(textarea.value).replace(/\n/g, "<br>");
            };

            textarea.addEventListener("input", updatePreview);
            overlay.querySelectorAll(".format-btn").forEach(btn => {
                btn.addEventListener("click", () => insertTag(textarea, btn.dataset.tag));
            });

            const save = () => {
                const text = textarea.value.trim();
                if (text.length < 1) {
                    errorDiv.textContent = "Минимум 1 символ";
                    return;
                }
                if (text.length > CONSTANTS.AR_MAX_LENGTH) {
                    errorDiv.textContent = `Максимум ${CONSTANTS.AR_MAX_LENGTH} символов`;
                    return;
                }

                if (isEdit) {
                    ar.text = sanitizeHTML(text);
                } else {
                    const newId = state.autoResponses.length > 0 ? Math.max(...state.autoResponses.map(a => a.id)) + 1 : 0;
                    state.autoResponses.push({ id: newId, text: sanitizeHTML(text) });
                }
                
                overlay.remove();
                renderAll();
                showNotification(isEdit ? "Сохранено" : "Добавлен", "success");
            };

            document.getElementById("modal-cancel").addEventListener("click", () => overlay.remove());
            document.getElementById("modal-save").addEventListener("click", save);
            textarea.addEventListener("keydown", (e) => {
                if (e.key === "Escape") overlay.remove();
                if (e.key === "Enter" && e.ctrlKey) save();
            });
            overlay.addEventListener("click", (e) => {
                if (e.target === overlay) overlay.remove();
            });

            setTimeout(() => textarea.focus(), 100);
        };

        const showRCModal = () => {
            const overlay = createModal(`
                <div class="modal">
                    <div class="modal-header"><i class="fas fa-cog"></i> Новый профиль</div>
                    <div class="modal-body">
                        <label class="form-label">Ключ (макс ${CONSTANTS.RC_KEY_MAX} символов)</label>
                        <input type="text" class="form-input" id="new-rc-key" maxlength="${CONSTANTS.RC_KEY_MAX}" placeholder="Название">
                        <label class="form-label margin-top">Мин. позиция</label>
                        <input type="number" class="form-input" id="new-rc-min-pos" value="0" max="${CONSTANTS.POSITION_MAX}">
                        <label class="form-label margin-top">Интервалы</label>
                        <div class="modal-intervals" id="new-rc-intervals">
                            <div class="modal-interval">
                                <input type="number" class="form-input" placeholder="От" value="0" max="${CONSTANTS.INTERVAL_MAX}" min="0">
                                <span class="sep">—</span>
                                <input type="number" class="form-input" placeholder="До" value="0" max="${CONSTANTS.INTERVAL_MAX}" min="0">
                            </div>
                        </div>
                        <button class="btn btn-sm" id="add-interval-btn" style="margin-top: 8px; width: 100%;">
                            <i class="fas fa-plus"></i> Интервал <span id="interval-count">(1/${CONSTANTS.MAX_INTERVALS})</span>
                        </button>
                        <div class="modal-error" id="modal-error"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-sm" id="modal-cancel">Отмена</button>
                        <button class="btn btn-success btn-sm" id="modal-save"><i class="fas fa-check"></i> Создать</button>
                    </div>
                </div>`);

            const keyInput = document.getElementById("new-rc-key");
            const minPosInput = document.getElementById("new-rc-min-pos");
            const errorDiv = document.getElementById("modal-error");
            const intervalsContainer = document.getElementById("new-rc-intervals");
            const countSpan = document.getElementById("interval-count");

            const updateCount = () => {
                const count = intervalsContainer.querySelectorAll(".modal-interval").length;
                countSpan.textContent = `(${count}/${CONSTANTS.MAX_INTERVALS})`;
                document.getElementById("add-interval-btn").disabled = count >= CONSTANTS.MAX_INTERVALS;
            };

            const addInterval = () => {
                const count = intervalsContainer.querySelectorAll(".modal-interval").length;
                if (count >= CONSTANTS.MAX_INTERVALS) return;
                
                const div = document.createElement("div");
                div.className = "modal-interval";
                div.innerHTML = `
                    <input type="number" class="form-input" placeholder="От" value="0" max="${CONSTANTS.INTERVAL_MAX}" min="0">
                    <span class="sep">—</span>
                    <input type="number" class="form-input" placeholder="До" value="0" max="${CONSTANTS.INTERVAL_MAX}" min="0">
                    <button class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button>`;
                
                div.querySelector(".btn-danger").addEventListener("click", () => {
                    div.remove();
                    updateCount();
                });
                
                intervalsContainer.appendChild(div);
                updateCount();
            };

            const getIntervals = () => Array.from(intervalsContainer.querySelectorAll(".modal-interval")).map(div => [
                parseInt(div.querySelectorAll("input")[0].value) || 0,
                parseInt(div.querySelectorAll("input")[1].value) || 0
            ]);

            const save = () => {
                const key = keyInput.value.trim();
                if (!key) { errorDiv.textContent = "Введите ключ"; return; }
                if (key.length > CONSTANTS.RC_KEY_MAX) { errorDiv.textContent = `Макс ${CONSTANTS.RC_KEY_MAX} символов`; return; }
                if (state.rc[key]) { errorDiv.textContent = "Уже существует"; return; }

                state.rc[key] = [parseInt(minPosInput.value) || 0, getIntervals()];
                overlay.remove();
                renderAll();
                showNotification("Профиль создан", "success");
            };

            document.getElementById("modal-cancel").addEventListener("click", () => overlay.remove());
            document.getElementById("modal-save").addEventListener("click", save);
            document.getElementById("add-interval-btn").addEventListener("click", addInterval);
            
            keyInput.addEventListener("keydown", (e) => {
                if (e.key === "Escape") overlay.remove();
                if (e.key === "Enter") save();
            });
            
            overlay.addEventListener("click", (e) => {
                if (e.target === overlay) overlay.remove();
            });

            setTimeout(() => keyInput.focus(), 100);
        };

        const showBulkModal = () => {
            const overlay = createModal(`
                <div class="modal">
                    <div class="modal-header"><i class="fas fa-edit"></i> Bulk Edit</div>
                    <div class="modal-body">
                        <label class="form-label">Найти</label>
                        <input type="text" class="form-input" id="bulk-find" placeholder="Подстрока для поиска...">
                        <label class="form-label margin-top">Заменить на</label>
                        <input type="text" class="form-input" id="bulk-replace" placeholder="Текст для замены...">
                        <div class="modal-bulk-preview" id="bulk-preview">
                            <div class="bulk-preview-empty">Начните вводить для предпросмотра</div>
                        </div>
                        <div class="bulk-preview-count" id="bulk-count"></div>
                        <div class="modal-error" id="modal-error"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-sm" id="modal-cancel">Отмена</button>
                        <button class="btn btn-success btn-sm" id="modal-apply" disabled><i class="fas fa-check"></i> Применить</button>
                    </div>
                </div>`);

            const findInput = document.getElementById("bulk-find");
            const replaceInput = document.getElementById("bulk-replace");
            const previewDiv = document.getElementById("bulk-preview");
            const countDiv = document.getElementById("bulk-count");
            const errorDiv = document.getElementById("modal-error");
            const applyBtn = document.getElementById("modal-apply");

            const smartReplace = (match, replace) => {
                if (match === match.toUpperCase()) return replace.toUpperCase();
                if (match[0] === match[0].toUpperCase()) return replace.charAt(0).toUpperCase() + replace.slice(1).toLowerCase();
                return replace.toLowerCase();
            };

            const updatePreview = () => {
                const find = findInput.value;
                const replace = replaceInput.value;

                if (!find) {
                    previewDiv.innerHTML = '<div class="bulk-preview-empty">Введите текст для поиска</div>';
                    countDiv.textContent = "";
                    applyBtn.disabled = true;
                    return;
                }

                const regex = new RegExp(`(${find.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "gi");
                const affected = state.items.filter(item => item[1].toLowerCase().includes(find.toLowerCase()));

                if (affected.length === 0) {
                    previewDiv.innerHTML = '<div class="bulk-preview-empty">Совпадений не найдено</div>';
                    countDiv.textContent = "";
                    applyBtn.disabled = true;
                    return;
                }

                previewDiv.innerHTML = `
                    <div class="bulk-preview-header">Предпросмотр (${affected.length} товаров)</div>
                    ${affected.slice(0, 50).map(item => {
                        const oldName = item[1];
                        const newName = oldName.replace(regex, (m) => smartReplace(m, replace));
                        const highlighted = oldName.split(regex).map((part, i) => 
                            i % 2 === 1 ? `<span style="background: rgba(76, 175, 80, 0.3);">${part}</span>` : part
                        ).join("");
                        return `<div class="bulk-preview-item"><div class="bulk-preview-old">${highlighted}</div><div class="bulk-preview-new">${newName}</div></div>`;
                    }).join("")}
                    ${affected.length > 50 ? `<div class="bulk-preview-empty">... и ещё ${affected.length - 50}</div>` : ""}`;

                countDiv.textContent = `Будет изменено: ${affected.length} товаров`;
                applyBtn.disabled = false;
            };

            const apply = () => {
                const find = findInput.value;
                const replace = replaceInput.value;
                if (!find) { errorDiv.textContent = "Введите текст для поиска"; return; }

                const regex = new RegExp(`(${find.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "gi");
                let count = 0;
                
                state.items.forEach(item => {
                    if (item[1].toLowerCase().includes(find.toLowerCase())) {
                        item[1] = item[1].replace(regex, (m) => smartReplace(m, replace));
                        count++;
                    }
                });

                overlay.remove();
                renderAll();
                showNotification(`Изменено: ${count} товаров`, "success");
            };

            findInput.addEventListener("input", updatePreview);
            replaceInput.addEventListener("input", updatePreview);
            document.getElementById("modal-cancel").addEventListener("click", () => overlay.remove());
            document.getElementById("modal-apply").addEventListener("click", apply);
            
            findInput.addEventListener("keydown", (e) => {
                if (e.key === "Escape") overlay.remove();
                if (e.key === "Enter" && !applyBtn.disabled) apply();
            });
            
            overlay.addEventListener("click", (e) => {
                if (e.target === overlay) overlay.remove();
            });

            setTimeout(() => findInput.focus(), 100);
        };

        const showInfoModal = () => {
            const overlay = createModal(`
                <div class="modal">
                    <div class="modal-header"><i class="fas fa-info-circle"></i> Информация</div>
                    <div class="modal-body"><p class="info-text">Редактор товаров для Telegram бота.</p></div>
                    <div class="modal-footer"><button class="btn btn-sm" id="modal-close">Закрыть</button></div>
                </div>`);
            
            document.getElementById("modal-close").addEventListener("click", () => overlay.remove());
            overlay.addEventListener("click", (e) => {
                if (e.target === overlay) overlay.remove();
            });
        };

        // Data Functions
        const exportData = () => {
            try {
                const moduleNames = Object.keys(state.modules);
                const data = {
                    ar: state.autoResponses.map(a => a.text),
                    rc: state.rc,
                    m: state.modules,
                    i: state.items.map(item => {
                        const moduleName = typeof item[0] === "string" ? item[0] : moduleNames[(item[0] || 1) - 1];
                        return [moduleName, item[1], item[2], item[3], item[4], item[5]];
                    })
                };
                
                const compressed = state.brotli.compress(encoder.encode(JSON.stringify(data)), { quality: 11 });
                navigator.clipboard.writeText(dataToBase64(compressed))
                    .then(() => {
                        showNotification("Скопировано в буфер обмена!", "success");
                        setTimeout(() => window.Telegram.WebApp.close(), 3000);
                    })
                    .catch(() => showNotification("Ошибка копирования", "error"));
            } catch (e) {
                showNotification("Ошибка экспорта", "error");
            }
        };

        const loadData = async () => {
            try {
                state.brotli = await import("https://unpkg.com/brotli-wasm@3.0.0/index.web.js?module").then(m => m.default);
                
                let dataParam = new URLSearchParams(window.location.search).get("items");
                
                if (!dataParam) {
                    // Test data
                    const testParams = "items=G0gFACySt0F46sSMw4vmRP%2F094z0BvLGo8ZD%2BxSmiQaR7iFKh8uEV6fv9xAmHdAZsDY3zOvfHeiLj49gBFK0DC0twX%2F%2Fl5L%2B8%2Fhua8SzPV1bGTAJUIpF538vPUwsgHeAIS5a%2Fu9Yg7ppjElLqK%2FUVyvYWiA1LVWkKuA53gg6oeHSclZTxzH0E1Br55G3Fp9LEf8%2F49cqLloE3iS15pAsMEWGzxxLRDM5hBCrnZ%2FbQYtkezasQpBpuz4hl3YPWd1HTnoIbpjI2%2FT9eo4qsO6Qv5QzPXE93ebNKBhJCxHguNQpBh05K%2Fhg16IBXWlYwoMPv6ofod%2B1zFcmNk7AdEAkWU4QCvqhwdB%2FD%2FKO2qHkrJ%2FYHYbnb7sQGyrNIWhvCp7gEjgzCiWh07GytUQacY%2BwEbOMBN1c66WJxUVVf09tJ%2FYzkTyxbi3oqy46i7325%2F%2Bt89fSCdhRB0HAU5o8j3uh5Q3htyJagn1w0FyUy3IiwePtOijPpcA3OzIjPN7K5TARtuK1yK6PZl90J4RkmoCX5Vu9y4hZphxVZUolp%2F6GRDfYCc6ggzLEOws4N%2BCFbKwkYo7j053tlgPGEiOkZeJY9YeWFwjwxPZ35j6ugySVLyDU%2FvLaENCENLlCzuArr8Is%2FWNYAxCfXVWteD4ARwM6b%2FSjrVre1ph15PkwDI5Or2%2BzDC2X7d3DYikZOQUlFTUNLR3ZMZsNfGRBTHPPZbRVoRUoy4t81D9Byvj7ubkfR3t1DA4%3D";
                    dataParam = new URLSearchParams(testParams).get("items");
                }

                const data = JSON.parse(decoder.decode(state.brotli.decompress(base64ToData(dataParam))));
                
                state.autoResponses = data.ar.map((text, index) => ({ id: index, text }));
                state.modules = data.m || CONSTANTS.DEFAULT_MODULES;

                // Ensure default ARs exist
                const hasFirst = state.autoResponses.some(ar => ar.text === "Это First Message");
                const hasLast = state.autoResponses.some(ar => ar.text === "Это Last Message");
                
                if (!hasFirst) {
                    const newId = state.autoResponses.length > 0 ? Math.max(...state.autoResponses.map(a => a.id)) + 1 : 0;
                    state.autoResponses.unshift({ id: newId, text: "Это First Message" });
                }
                if (!hasLast) {
                    const newId = state.autoResponses.length > 0 ? Math.max(...state.autoResponses.map(a => a.id)) + 1 : 0;
                    state.autoResponses.splice(1, 0, { id: newId, text: "Это Last Message" });
                }

                const firstId = state.autoResponses.find(ar => ar.text === "Это First Message")?.id;
                const lastId = state.autoResponses.find(ar => ar.text === "Это Last Message")?.id;

                const moduleNames = Object.keys(state.modules);
                state.items = data.i.map(item => {
                    const moduleName = typeof item[0] === "string" ? item[0] : moduleNames[(item[0] || 1) - 1];
                    return [
                        moduleName || moduleNames[0] || "Unknown",
                        item[1],
                        item[2].length >= 2 ? item[2] : [firstId, lastId],
                        item[3] || {},
                        item[4] || 0,
                        item[5] || "default"
                    ];
                });

                state.rc = data.rc || {};
                if (Object.keys(state.rc).length === 0) {
                    state.rc["default"] = [1000, [[9, 22]]];
                }

                renderAll();
            } catch (error) {
                console.error("Load error:", error);
                showNotification("Ошибка загрузки данных", "error");
            }
        };

        // Render Functions
        const renderAll = () => {
            renderItemsList();
            renderItemSettings();
            renderAutoResponses();
            renderRCSettings();
        };

        const getFilteredItems = () => 
            state.searchQuery 
                ? state.items.filter(item => item[1].toLowerCase().includes(state.searchQuery.toLowerCase()))
                : state.items;

        const renderItemsList = () => {
            const container = document.getElementById("items-list");
            const filtered = getFilteredItems();
            document.getElementById("items-count").textContent = `(${state.items.length})`;

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-search"></i><p>${state.searchQuery ? "Ничего не найдено" : "Нет товаров"}</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const idx = state.items.indexOf(item);
                return `
                    <div class="item ${idx === state.selectedIndex ? "selected" : ""}" data-index="${idx}">
                        <div class="item-name" title="${item[1]}">${item[1]}</div>
                        <div class="item-actions">
                            <button class="item-btn item-btn-copy" data-index="${idx}" title="Копировать"><i class="fas fa-copy"></i></button>
                            <button class="item-btn item-btn-delete" data-index="${idx}" title="Удалить"><i class="fas fa-times"></i></button>
                        </div>
                    </div>`;
            }).join("");

            container.querySelectorAll(".item").forEach(el => {
                el.addEventListener("click", (e) => {
                    if (!e.target.closest(".item-btn")) selectItem(parseInt(el.dataset.index));
                });
            });

            container.querySelectorAll(".item-btn-delete").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.index);
                    if (state.confirmDelete ? confirm(`Удалить "${state.items[idx][1]}"?`) : true) {
                        deleteItem(idx);
                    }
                });
            });

            container.querySelectorAll(".item-btn-copy").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    copyItem(parseInt(btn.dataset.index));
                });
            });
        };

        const deleteItem = (index) => {
            state.items.splice(index, 1);
            if (state.selectedIndex === index) state.selectedIndex = -1;
            else if (state.selectedIndex > index) state.selectedIndex--;
            renderAll();
            showNotification("Товар удалён", "success");
        };

        const copyItem = (index) => {
            const original = state.items[index];
            const copy = [original[0], original[1], [...original[2]], { ...original[3] }, original[4], original[5]];
            state.items.splice(index + 1, 0, copy);
            state.selectedIndex = index + 1;
            renderAll();
            showNotification("Товар скопирован", "success");
        };

        const addItem = () => {
            const firstId = state.autoResponses[0]?.id;
            const lastId = state.autoResponses[1]?.id ?? firstId;
            const moduleNames = Object.keys(state.modules);
            const defaultModule = moduleNames.includes("ItemReupload") ? "ItemReupload" : moduleNames[0] || "Unknown";
            
            state.items.push([defaultModule, "Новый товар", [firstId, lastId], {}, 0, "default"]);
            state.selectedIndex = state.items.length - 1;
            renderAll();
            showNotification("Товар добавлен", "success");
        };

        const selectItem = (index) => {
            state.selectedIndex = index;
            renderItemsList();
            renderItemSettings();
            // Auto-scroll to center panel on mobile when item selected
            if (isMobile()) {
                setTimeout(() => scrollToPanel(1), 100);
            }
        };

        const getModuleInfo = (item) => {
            const moduleNames = Object.keys(state.modules);
            return state.modules.hasOwnProperty(item[0]) 
                ? { name: item[0], ars: state.modules[item[0]] }
                : { name: moduleNames[0] || "Unknown", ars: [] };
        };

        const renderItemSettings = () => {
            const container = document.getElementById("item-settings");
            
            if (state.selectedIndex === -1) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><h3>Товар не выбран</h3><p>Выберите товар из списка</p></div>`;
                return;
            }

            const item = state.items[state.selectedIndex];
            const moduleNames = Object.keys(state.modules);
            const { name: moduleName, ars: moduleARs } = getModuleInfo(item);
            const [firstId] = item[2];

            const renderARSelect = (label, arIndex, arName) => {
                const currentId = item[2][arIndex] ?? firstId;
                const currentAR = state.autoResponses.find(a => a.id === currentId);
                return `
                    <div class="ar-fixed-item">
                        <label class="form-label"><i class="fas fa-play"></i> ${arName}</label>
                        <div class="ar-select-wrapper" data-ar-index="${arIndex}">
                            <input type="text" class="form-input" value="${currentAR?.text || ""}" placeholder="Начните вводить для поиска..." autocomplete="off">
                            <div class="ar-select-dropdown">
                                ${state.autoResponses.map(ar => `
                                    <div class="ar-select-option ${ar.id === currentId ? "selected" : ""}" data-ar-id="${ar.id}">
                                        ${ar.text.length > 100 ? ar.text.substring(0, 100) + "..." : ar.text}
                                    </div>
                                `).join("")}
                            </div>
                        </div>
                    </div>`;
            };

            container.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div class="section section-auto">
                        <div class="section-title"><i class="fas fa-cube"></i> Модуль</div>
                        <select class="form-input" id="item-module">
                            ${moduleNames.map(key => `<option value="${key}" ${moduleName === key ? "selected" : ""}>${key}</option>`).join("")}
                        </select>
                    </div>
                    <div class="section section-auto section-pad-top">
                        <div class="section-title"><i class="fas fa-tag"></i> Название</div>
                        <input type="text" class="form-input" id="item-name" value="${item[1]}" maxlength="72" placeholder="Название товара">
                        <p class="hint">Максимум 72 символа</p>
                    </div>
                    <div class="section section-stretch">
                        <div class="section-title"><i class="fas fa-reply"></i> Авто ответы</div>
                        <div class="ar-fixed-section">
                            ${renderARSelect("First Message", 0, "First Message")}
                            ${renderARSelect("Last Message", 1, "Last Message")}
                            ${moduleARs.map((arName, idx) => renderARSelect(arName, idx + 2, arName)).join("")}
                        </div>
                    </div>
                    <div class="section section-auto section-pad-top">
                        <div class="bump-toggle-section">
                            <div class="bump-toggle-header">
                                <div class="bump-toggle-title"><i class="fas fa-rocket"></i> Авто поднятие</div>
                                <div class="bump-status ${item[4] ? "on" : "off"}">
                                    <div class="bump-status-dot"></div>${item[4] ? "Включено" : "Выключено"}
                                </div>
                            </div>
                            <button class="btn ${item[4] ? "btn-success" : ""}" id="auto-bump-toggle" style="width: 100%;">
                                <i class="fas fa-power-off"></i> ${item[4] ? "Авто поднятие включено" : "Включить авто поднятие"}
                            </button>
                        </div>
                        <label class="form-label">Профиль</label>
                        <select class="form-select" id="auto-bump-key">
                            ${Object.keys(state.rc).map(key => `<option value="${key}" ${item[5] === key ? "selected" : ""}>${key}</option>`).join("")}
                        </select>
                        ${item[5] && state.rc[item[5]] ? `
                            <div class="rc-preview">
                                <div class="rc-preview-title">Настройки профиля</div>
                                <div class="rc-preview-row">Мин. позиция: <span>${state.rc[item[5]][0]}</span></div>
                                <div class="rc-preview-intervals">
                                    ${state.rc[item[5]][1].map(interval => `
                                        <div class="rc-preview-interval"><i class="fas fa-circle"></i>${interval[0]} — ${interval[1]}</div>
                                    `).join("")}
                                </div>
                            </div>
                        ` : ""}
                    </div>
                </div>`;

            // Event listeners
            document.getElementById("item-name").addEventListener("input", (e) => {
                item[1] = e.target.value;
                renderItemsList();
            });

            document.getElementById("item-module").addEventListener("change", (e) => {
                item[0] = e.target.value;
                renderItemSettings();
            });

            document.getElementById("auto-bump-toggle").addEventListener("click", function() {
                item[4] = item[4] ? 0 : 1;
                renderItemSettings();
                renderItemsList();
            });

            document.getElementById("auto-bump-key").addEventListener("change", (e) => {
                item[5] = e.target.value;
                renderItemSettings();
            });

            // AR Select dropdowns
            container.querySelectorAll(".ar-select-wrapper").forEach(wrapper => {
                const input = wrapper.querySelector("input");
                const dropdown = wrapper.querySelector(".ar-select-dropdown");
                const arIndex = parseInt(wrapper.dataset.arIndex);

                const positionDropdown = () => {
                    const rect = input.getBoundingClientRect();
                    dropdown.style.left = rect.left + "px";
                    dropdown.style.top = rect.bottom + 4 + "px";
                    dropdown.style.width = Math.min(rect.width, window.innerWidth - rect.left - 20) + "px";
                };

                const filterOptions = (filter = "") => {
                    dropdown.querySelectorAll(".ar-select-option").forEach(opt => {
                        const arId = parseInt(opt.dataset.arId);
                        const ar = state.autoResponses.find(a => a.id === arId);
                        const matches = ar && ar.text.toLowerCase().includes(filter.toLowerCase());
                        opt.style.display = matches ? "" : "none";
                        opt.classList.toggle("selected", arId === (item[2][arIndex] ?? firstId));
                    });
                };

                input.addEventListener("focus", () => {
                    positionDropdown();
                    dropdown.style.display = "block";
                    filterOptions(input.value);
                });

                input.addEventListener("input", () => filterOptions(input.value));
                
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        dropdown.style.display = "none";
                        input.blur();
                    }
                });

                dropdown.querySelectorAll(".ar-select-option").forEach(opt => {
                    opt.addEventListener("click", () => {
                        const arId = parseInt(opt.dataset.arId);
                        const ar = state.autoResponses.find(a => a.id === arId);
                        if (ar) {
                            input.value = ar.text;
                            item[2][arIndex] = arId;
                            dropdown.style.display = "none";
                        }
                    });
                });

                document.addEventListener("click", (e) => {
                    if (!wrapper.contains(e.target)) dropdown.style.display = "none";
                });

                window.addEventListener("resize", positionDropdown);
            });
        };

        const renderAutoResponses = () => {
            const container = document.getElementById("auto-tab");
            
            container.innerHTML = `
                <div class="section" style="margin-bottom: 12px;">
                    <div class="section-title"><i class="fas fa-list"></i> Все (${state.autoResponses.length})</div>
                    <button class="btn btn-primary btn-block btn-sm" id="add-ar-btn"><i class="fas fa-plus"></i> Добавить</button>
                </div>
                <div class="ar-list">
                    ${state.autoResponses.length > 0 
                        ? state.autoResponses.map(ar => `
                            <div class="ar-item" data-ar-id="${ar.id}">
                                <span class="ar-text" title="${ar.text}">${ar.text}</span>
                                <div class="ar-actions">
                                    <button class="ar-btn edit" data-ar-id="${ar.id}"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="ar-btn" data-ar-id="${ar.id}"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        `).join("")
                        : '<div class="empty-state"><p>Нет авто ответов</p></div>'
                    }
                </div>`;

            requestAnimationFrame(() => {
                container.querySelectorAll(".ar-btn.edit").forEach(btn => {
                    btn.addEventListener("click", () => showARModal(true, parseInt(btn.dataset.arId)));
                });

                container.querySelectorAll(".ar-btn:not(.edit)").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const id = parseInt(btn.dataset.arId);
                        if (!state.confirmDelete || confirm("Удалить авто ответ?")) {
                            state.autoResponses = state.autoResponses.filter(a => a.id !== id);
                            state.items.forEach(item => {
                                item[2] = item[2].filter(arId => arId !== id);
                            });
                            renderAll();
                            showNotification("Удалён", "success");
                        }
                    });
                });

                document.getElementById("add-ar-btn").addEventListener("click", () => showARModal(false));
            });
        };

        const renderRCSettings = () => {
            const container = document.getElementById("rc-tab");
            const rcKeys = Object.keys(state.rc);

            container.innerHTML = `
                <div class="section" style="margin-bottom: 12px;">
                    <div class="section-title"><i class="fas fa-chart-line"></i> Профили (${rcKeys.length})</div>
                    <button class="btn btn-primary btn-block btn-sm" id="add-rc-btn"><i class="fas fa-plus"></i> Создать</button>
                </div>
                <div class="rc-list">
                    ${rcKeys.length > 0 
                        ? rcKeys.map(key => `
                            <div class="rc-card" data-key="${key}">
                                <div class="rc-card-header">
                                    <span class="rc-card-title"><i class="fas fa-sliders-h"></i> ${key}</span>
                                    <button class="btn btn-sm btn-danger" data-key="${key}"><i class="fas fa-trash"></i></button>
                                </div>
                                <div class="rc-card-body">
                                    <label class="form-label">Мин. позиция</label>
                                    <input type="number" class="form-input rc-min-pos" data-key="${key}" value="${state.rc[key][0]}" max="${CONSTANTS.POSITION_MAX}">
                                    <label class="form-label margin-top">Интервалы</label>
                                    <div class="rc-intervals" data-key="${key}">
                                        ${state.rc[key][1].map((interval, idx) => `
                                            <div class="rc-row">
                                                <input type="number" class="rc-from" data-key="${key}" data-idx="${idx}" value="${interval[0]}" max="${CONSTANTS.INTERVAL_MAX}" min="0">
                                                <span class="sep">—</span>
                                                <input type="number" class="rc-to" data-key="${key}" data-idx="${idx}" value="${interval[1]}" max="${CONSTANTS.INTERVAL_MAX}" min="0">
                                                <button class="btn btn-sm btn-danger" data-key="${key}" data-idx="${idx}"><i class="fas fa-times"></i></button>
                                            </div>
                                        `).join("")}
                                    </div>
                                    <button class="btn btn-sm" data-key="${key}" ${state.rc[key][1].length >= CONSTANTS.MAX_INTERVALS ? "disabled" : ""}>
                                        <i class="fas fa-plus"></i> Интервал (${state.rc[key][1].length}/${CONSTANTS.MAX_INTERVALS})
                                    </button>
                                </div>
                            </div>
                        `).join("")
                        : '<div class="empty-state"><i class="fas fa-sliders-h"></i><p>Нет профилей</p></div>'
                    }
                </div>`;

            requestAnimationFrame(() => {
                container.querySelectorAll(".rc-min-pos").forEach(input => {
                    input.addEventListener("input", (e) => {
                        state.rc[e.target.dataset.key][0] = parseInt(e.target.value) || 0;
                    });
                });

                container.querySelectorAll(".rc-from, .rc-to").forEach(input => {
                    input.addEventListener("input", () => {
                        const { key, idx } = input.dataset;
                        const fromInput = container.querySelector(`.rc-from[data-key="${key}"][data-idx="${idx}"]`);
                        const toInput = container.querySelector(`.rc-to[data-key="${key}"][data-idx="${idx}"]`);
                        let from = parseInt(fromInput.value) || 0;
                        let to = parseInt(toInput.value) || 0;
                        
                        if (from > CONSTANTS.INTERVAL_MAX) from = CONSTANTS.INTERVAL_MAX;
                        if (to > CONSTANTS.INTERVAL_MAX) to = CONSTANTS.INTERVAL_MAX;
                        if (to < from) to = from;
                        
                        fromInput.value = from;
                        toInput.value = to;
                        state.rc[key][1][idx] = [from, to];
                    });
                });

                container.querySelectorAll(".btn-danger[data-idx]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const { key, idx } = btn.dataset;
                        if (!state.confirmDelete || confirm("Удалить интервал?")) {
                            state.rc[key][1].splice(idx, 1);
                            renderRCSettings();
                            if (state.selectedIndex !== -1) renderItemSettings();
                        }
                    });
                });

                container.querySelectorAll(".btn[data-key]:not(.btn-danger)").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const key = btn.dataset.key;
                        if (state.rc[key][1].length >= CONSTANTS.MAX_INTERVALS) {
                            showNotification(`Максимум ${CONSTANTS.MAX_INTERVALS} интервалов`, "error");
                            return;
                        }
                        state.rc[key][1].push([0, 0]);
                        renderRCSettings();
                    });
                });

                container.querySelectorAll(".btn-danger[data-key]:not([data-idx])").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const key = btn.dataset.key;
                        if (!state.confirmDelete || confirm(`Удалить профиль "${key}"?`)) {
                            delete state.rc[key];
                            state.items.forEach(item => { if (item[5] === key) item[5] = ""; });
                            renderAll();
                            showNotification("Профиль удалён", "success");
                        }
                    });
                });

                document.getElementById("add-rc-btn").addEventListener("click", showRCModal);
            });
        };

        // Event Listeners
        document.addEventListener("DOMContentLoaded", () => {
            // Tabs
            document.querySelectorAll(".tab").forEach(tab => {
                tab.addEventListener("click", () => {
                    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
                    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
                    tab.classList.add("active");
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add("active");
                });
            });

            // Main actions
            document.getElementById("export-btn").addEventListener("click", exportData);
            document.getElementById("info-btn").addEventListener("click", showInfoModal);
            document.getElementById("add-item-btn").addEventListener("click", addItem);
            document.getElementById("bulk-edit-btn").addEventListener("click", showBulkModal);
            
            document.getElementById("confirm-delete").addEventListener("change", (e) => {
                if (!e.target.checked && !confirm("Отключить подтверждение удаления?")) {
                    e.target.checked = true;
                } else {
                    state.confirmDelete = e.target.checked;
                }
            });

            document.getElementById("search-input").addEventListener("input", (e) => {
                state.searchQuery = e.target.value.trim();
                renderItemsList();
            });

            // Mobile touch handling
            const app = document.querySelector('.app');
            
            // Включаем snap для мобильных при загрузке
            if (isMobile()) {
                app.classList.add('snap-enabled');
            }
            
            app.addEventListener('touchstart', handleTouchStart, { passive: true });
            app.addEventListener('touchend', handleTouchEnd, { passive: true });
            
            // Update current panel on scroll (только когда snap включен - естественный скролл)
            app.addEventListener('scroll', () => {
                if (!isMobile() || !app.classList.contains('snap-enabled')) return;
                const newPanel = getCurrentPanelFromScroll(app.scrollLeft);
                if (newPanel !== state.currentPanel) {
                    state.currentPanel = newPanel;
                }
            });
            
            // Handle resize
            window.addEventListener('resize', () => {
                if (!isMobile()) {
                    app.classList.remove('snap-enabled');
                    app.scrollLeft = 0;
                } else {
                    app.classList.add('snap-enabled');
                }
            });
            
            // Init Telegram
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.enableClosingConfirmation();
            
            // Load data
            loadData();
        });
    </script>
</body>
</html>
